# CPL WebAssembly Edition

This directory contains the WebAssembly build of the CPL (Categorical Programming Language) interpreter.

## Files

- **index.html** - Web interface with xterm.js terminal emulator
- **cpl-terminal.js** - JavaScript terminal controller and WASM loader
- **cpl.wasm** - Compiled CPL interpreter (generated by build process)

## Building

The WASM binary is built using GHC's WebAssembly backend. To build it yourself:

```bash
# From the project root
./scripts/build-wasm.sh
```

Requirements:
- GHC 9.10.3 or later with WASM cross-compiler
- wasm32-wasi-ghc and wasm32-wasi-cabal in PATH

## Testing Locally

To test the WASM version locally:

```bash
cd wasm
python3 -m http.server 8000
```

Then open http://localhost:8000 in your browser.

## Deployment

The WASM version is automatically built and deployed to GitHub Pages via GitHub Actions whenever changes are pushed to the master branch.

See `.github/workflows/wasm-deploy.yaml` for the deployment configuration.

## Browser Compatibility

Tested and working on:
- Chrome/Chromium 90+
- Firefox 90+
- Safari 15+
- Edge 90+

## Architecture

### Haskell Side (src/Main.hs)

The Haskell code uses CPP macros to conditionally compile different Console implementations:

- `USE_WASM_BACKEND` - JavaScript FFI for WebAssembly
- `USE_READLINE_PACKAGE` - Readline library (native)
- `USE_HASKELINE_PACKAGE` - Haskeline library (native)
- Default - Plain IO (native)

For WASM, three JavaScript FFI functions are exposed:
- `terminal_initialize()` - Initialize xterm.js terminal
- `terminal_printLine(text)` - Print a line to terminal
- `terminal_readLine(prompt)` - Read user input (async)

### JavaScript Side (cpl-terminal.js)

The JavaScript side provides:
- **CPLTerminal class** - Manages xterm.js terminal instance
- **Keyboard handling** - Enter, Backspace, Ctrl+C, Ctrl+D, Tab
- **WASM loading** - Fetches and instantiates WASM module
- **FFI bindings** - Connects Haskell to JavaScript

### Build Configuration (CPL.cabal)

The WASM flag in CPL.cabal enables WebAssembly-specific build options:

```cabal
Flag WASM
  Description: Build for WebAssembly with JavaScript FFI
  Default: False
  Manual: True
```

When enabled:
- Sets `-DUSE_WASM_BACKEND` CPP flag
- Uses `-no-hs-main` (no standard main entry point)
- Exports `hs_init` and `hs_start` symbols
- Enables `JavaScriptFFI` extension for GHC 9.10+

## Known Limitations

Current WASM implementation does not support:
- **load/save commands** - No file system access yet
- **Command history** - Basic line editing only
- **Tab completion** - Not implemented
- **Multi-line paste** - May have issues with large pastes

These features may be added in future versions.

## Troubleshooting

### WASM module fails to load

Check browser console for errors. Common issues:
- Missing or incorrect MIME type for .wasm files
- CORS issues (must serve from web server, not file://)
- Browser doesn't support WebAssembly

### Terminal not responding

- Ensure JavaScript is enabled
- Check browser console for errors
- Try refreshing the page

### Build errors

If `./scripts/build-wasm.sh` fails:
- Verify GHC WASM toolchain is installed correctly
- Check that wasm32-wasi-ghc and wasm32-wasi-cabal are in PATH
- Try `./scripts/build-wasm.sh --clean` to clean build artifacts

## Performance

The WASM version should have similar performance to the native version for most operations. Initial load time depends on:
- WASM binary size (~20-25 MB typical)
- Network speed (for first load)
- Browser WASM compilation

Subsequent loads are faster due to browser caching.

## Security

The WASM version runs in the browser's sandbox and has no access to:
- Local file system (except via browser file picker APIs, not yet implemented)
- Network (except for loading the WASM module itself)
- Other tabs or browser state

This makes it safe to run untrusted CPL programs in the browser.

## Contributing

To improve the WASM version:

1. Modify Haskell code in `src/Main.hs` (USE_WASM_BACKEND section)
2. Update JavaScript in `wasm/cpl-terminal.js`
3. Test locally with `python3 -m http.server`
4. Submit pull request

See main README.md for general contribution guidelines.
